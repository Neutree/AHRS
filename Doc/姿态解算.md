---
title: 姿态解算
---

# 知识库
## 名称解释

### 姿态解算
目标机体通过配备惯性检测元件（IMU）以及其它传感器（如磁力计、GPS）采集得到的数据再经过某些算法，从而得到机体的姿态信息（如Pitch,Roll,Yaw）的过程就叫姿态解算

### 欧拉角
机体从一个坐标系转动到另一个坐标系可以通过依次围绕不同的坐标轴的3次连续转动得到。这三次绕三个轴转动的三个角度就是欧拉角。对于同一个姿态，用不同的欧拉角顺序描述时，对应的欧拉角是不同的。只有将欧拉角应用于惯性导航领域时才有偏航角（heading or yaw）、俯仰角(clcvation or pitch)和横滚角(bank or roll)的概念.欧拉角有万向节死锁

### 万向节死锁（Gimbal Lock）
欧拉角作为姿态解析的致命缺点就是万向节死锁。
如图，当两个周重合之后，图中灰色阴影的方向就无法通过一次旋转得到
![万向节死锁][1]
[视频](http://www.tudou.com/programs/view/C39rWfrXRkY)
举个例子说明：
> 假如我们有一个望远镜和一个用来放望远镜的三脚架，（我们将）三脚架放在地面上，使支撑望远镜的三脚架的顶部是平行于地平面（参考平面）的，以便使得竖向的旋转轴（记为x轴）是完全地垂直于地平面的。现在，我们就可以将望远镜饶x轴旋转360度，从而观察（以望远镜为中心的）水平包围圈的所有方向。通常将正北朝向方位角度记为0度方位角。第二个坐标轴，即平行于地平面的横向的坐标轴（记为y轴）使得望远镜可以饶着它上下旋转，通常将地平面朝向的仰角记为0度，这样，望远镜可以向上仰+90度指向天顶，或者向下-90度指向脚底。好了，万事俱备。现在，天空中（包括地面上）的每个点只需要唯一的一对x和y度数就可以确定。比如x=90度,y=45度指向的点是位于正东方向的半天空上。现在，看看万向节死锁是怎么发生的。一次，我们探测到有一个飞行器贴地飞行，位于望远镜的正东方向（x=90度，y=10度），朝着我们直飞过来，我们跟踪它。飞行器飞行方向是保持x轴角度90度不变，而y向的角度在慢慢增大。随着飞行器的临近，y轴角增长的越来越快且当y向的角度达到90度时（即将超越），突然它急转弯朝南飞去。这时，我们发现我们不能将望远镜朝向南方，因为此时y向已经是90度，造成我们失去跟踪目标。这就是万向节死锁！

> 为什么说不能将望远镜朝向南方呢，让我们看看坐标变化，从开始的（x=90度，y=10度）到（x=90度，y=90度），这个过程没有问题，望远镜慢慢转动跟踪飞行器。当飞行器到达（x=90度，y=90度）后，坐标突然变成（x=180度，y=90度）（因为朝南），x由90突变成180度,所以望远镜需要饶垂直轴向x轴旋转180-90=90度以便追上飞行器,但此时，望远镜已经是平行于x轴，我们知道饶平行于自身的中轴线的的旋转改变不了朝向，就象拧螺丝一样，螺丝头的指向不变。所以望远镜的指向还是天顶。而后由于飞行器飞远，坐标变成(x=180度，y < 90度)时，y向角减小，望远镜只能又转回到正东指向，望'器'兴叹。这说明用x,y旋转角（又称欧拉角）来定向物体有时并不能按照你想像的那样工作，象上面的例子中从（x=90度，y=10度）到（x=90度，y=90度），按照欧拉角旋转确实可以正确地定向，但从（x=90度，y=90度）到（x=180度，y=90度），再到（x=180度，y< 90度）,按照欧拉角旋转后的定向并非正确。我的理解是坐标值的变化和飞行器空间的位置变化一一对应，但是从（x=90度，y=90度）到（x=180度，y=90度），再到（x=180度，y< 90度）这个变化，飞行器位置是连续的变化，但坐标值的变化却不是连续的（从90突变到180），其原因在于（x=90度，y=90度）和（x=180度，y=90度）甚至和（x=任意度，y=90度）这些不同的坐标值对应空间同一个位置，这种多个坐标值对应同一个位置的不一致性是造成死锁的根源。

> 上面是2维坐标系中的例子，同样，对于3维的也一样。比如有一个平行于x轴的向量，我们先将它饶y旋转直到它平行于z轴，这时，我们会发现任何饶z的旋转都改变不了向量的方向，即万向节死锁，所以说传统的欧拉角是不能做到全姿态解析的


### 右手坐标系
在空间直角坐标系中，让右手拇指指向x轴的正方向，食指指向y轴的正方向，如果中指能指向z轴的正方向，则称这个坐标系为右手直角坐标系．同理左手直角坐标系
![enter description here][2]

### 方向余弦矩阵
一个向量在坐标系中的位置也可以用方向余弦表示，也就是这个向量分别到三个坐标轴的夹角余弦值，实际上就是这个向量到各个坐标轴的投影.推广到载体坐标系和参考坐标系当中，我们就有了机体坐标轴xyz分别与参考轴XYZ的方向余弦，这里就是所说的方向余弦矩阵了，它是由两组不同的标准正交基的基底向量之间的方向余弦所形成的3x3矩阵。方向余弦矩阵可以用来表达一组标准正交基与另一组标准正交基之间的关系。余弦矩阵的列表示载体坐标系中的单位矢量在参考坐标系中的投影

机体坐标系(R系)**R**=[**X~r~、Y~r~、Z~r~**]^T^ 
参考坐标系(O系)**O**=[ **X~o~、Y~o~、Z~o~**]^T^ 

![方向余弦矩阵表示][3]
其中C^r^~o~表示坐标系O变化到坐标系R的余弦矩阵，也叫变化矩阵
其中C^o^~r~表示坐标系R变化到坐标系O的余弦矩阵

  R =C^r^~o~ O 
  
 接下来推导一下绕三个轴旋转的方向余弦矩阵
 设坐标系X1、Y1、Z1绕OZ1轴旋转α角后得到坐标系X2、Y2、Z2,空间矢量**r**在原坐标系内的投影为[ r~x1~,r~y1~,r~z1~]^T^ 在新坐标系内的投影为[ r~x2~,r~y2~,r~z2~]^T^ 要求得到两组坐标系值之间的关系。由于旋转绕Z轴进行，所以Z坐标未变，r~z1~=r~z2~ 。作图：
>![enter description here][4]

r~x2~ 
=OA+AB+BC
=ODcosα +BDsinα+BFsinα
因为 BD+BF = r~y1~
=r~x1~cosα + r~y1~sinα

r~y2~
=DE-AD
因为相似三角形可得角ADB等于α，所以DE=cosαDF=cosr~y1~，在△AOD中AD=sinαOD=sinr~x1~
=cosr~y1~ - sinr~x1~

r~z2~ = r~z1~

将上面三个方程写成矩阵形式
>![enter description here][5]
>记   ![enter description here][6]

C^2^~1~称为从坐标系1至坐标系2的变换矩阵。诸元是坐标系1各轴上的单位1在坐标系2各轴上的投影。
>![enter description here][7]

两坐标系间任何复杂的角位置关系都可以看做有限次基本旋转的复合，变换矩阵等于基本旋转确定的变换矩阵的连乘，连乘顺序依基本旋转的先后次序由右向左排列。例如机体的空间姿态可看作依次绕航向轴、俯仰轴、横滚轴作基本旋转后的复合结果。
>![enter description here][8]

各次基本旋转对应的变换矩阵:
>![enter description here][9]

符号与上面的公式不符合是因为对其进行了转置，也就是改变了系的变化方向
姿态矩阵为:
>![enter description here][10]
 

### 四元素

四元数（Quaternions）是由威廉·卢云·哈密尔顿在1843年发现的数学概念。从明确地角度而言，四元数是复数的不可交换延伸。如把四元数的集合考虑成多维实数空间的话，四元数就代表着一个四维空间，相对于复数为二维空间。

实数域扩充到复数域，并用复数来表示平面向量，用复数的加、乘运算表示平面向量的合成、伸缩和旋，这就是我们熟知的复数的二维空间含义，所以人们会继续猜想，利用三维复数不就可以表达三维空间的变换了吗，历史上有很多数学家试图寻找过三维的复数，但后来证明这样的三维复数是不存在的。有关这个结论的证明，我没有查到更明确的版本，据《古今数学思想》中的一个理由，三维空间中的伸缩旋转变换需要四个变量来决定：两个变量决定轴的方向，一个变量决定旋转角度，一个变量决定伸缩比例。这样，只有三个变量的三维复数无法满足这样的要求。但是历史上得到的应该是比这个更强的结论，即使不考虑空间旋转，只从代数角度来说，三维的复数域作为普通复数域的扩张域是不存在的。并且，据《古今数学思想》叙述，即使像哈密尔顿后来引入四元数那样，牺牲乘法交换律，这样的三维复数也得不到。经过一些年的努力之后， Hamilton 发现自己被迫应作两个让步，第一个是他的新数包含四个分量，而第二个是他必须牺牲乘法交换律。（《古今数学思想》第三册177 页）但是四元数用作旋转的作用明显，简化了运算，而且避免了万向锁（Gimbal Lock），四元数是最简单的超复数，我们不能把四元数简单的理解为3D空间的矢量，它是4维空间中的的矢量，也是非常不容易想像的。

四元数都是由实数加上三个元素 i、j、k 组成，他们有下列关系
i^2^=j^2^=k^2^ = ijk = -1
每个四元数都是  i、  j 和  k 的线性组合，即是四元数一般可表示为
 a+bi+cj+dk
 
我们知道在平面(x,y)中的旋转可以用复数来表示，同样的三维中的旋转可以用单位四元数来描述。我们来定义一个四元数：
>![enter description here][11]

上式可以写作[**W,V**]，其中**V**=q~1~i+q~2~j+q~3~k ， **w**=a=q~0~。
**v**是矢量，表示三维空间中的旋转轴。**W**是标量，表示旋转角度。那么[**W,V**]就是绕轴V旋转W度，所以四元素可以表示一个完整的旋转。并且只有单位四元素才可以表示旋转，这是四元素表示旋转的约束条件。

如何求单位四元素呢，如下：
>四元数可以理解为一个实数和一个向量的组合，也可以理解为四维的向量。这里用一个圈表示q是一个四元数
>![enter description here][12]

四元素相乘可以用来组合旋转
![enter description here][13]


四元数大量用于电脑绘图（及相关的图像分析）上表示三维物件的旋转及方位。四元数亦见于控制论、信号处理、姿态控制、物理和轨道力学，都是用来表示旋转和方位。
相对于另几种旋转表示法（矩阵，欧拉角，轴角），四元数具有某些方面的优势，如速度更快、提供平滑插值、有效避免万向锁问题、存储空间较小等等。


### 陀螺仪
陀螺仪，测量角速度，具有高动态特性，它是一个间接测量角度的器件。它测量的是角度的导数，即角速度，要将角速度对时间积分才能得到角度。
陀螺仪就是内部有一个陀螺，它的轴由于陀螺效应始终与初始方向平行，这样就可以通过与初始方向的偏差计算出旋转方向和角度。传感器MPU6050实际上是一个结构非常精密的芯片，内部包含超微小的陀螺。
如果这个世界是理想的，美好的，那我们的问题到此就解决了，从理论上讲只用陀螺仪是可以完成姿态导航的任务的。只需要对3个轴的陀螺仪角速度进行积分，得到3个方向上的旋转角度，也就是姿态数据。这也就是说的快速融合。
不过很遗憾，现实是残酷的，由于误差噪声等的存在，对陀螺仪积分并不能够得到完全准确的姿态，尤其是运转一段时间以后，积分误差的累加会让得到的姿态和实际的相差甚远。
那么哪些原因会使陀螺仪得到的姿态结果不准确呢？下面列举除常见的几种：
* 零点漂移
假设陀螺仪固定不动，理想角速度值是0dps(degree per second)，但是存在零点漂移，例如有一个偏置0.1dps加在上面，于是测量出来是0.1dps，积分一秒之后，得到的角度是0.1度，1分钟之后是6度，还能忍受，一小时之后是360度，转了一圈，也就是说，陀螺仪在短时间内有很大的参考价值。
* 白噪声
电信号的测量中，一定会带有白噪声，陀螺仪数据的测量也不例外。所以获得的陀螺仪数据中也会带有白噪声，而且这种白噪声会随着积分而累加。
* 温度/加速度影响
陀螺仪是一个温度和加速度敏感的元器件。例如对于加速度，多轴飞行器中的马达一般会带来较强烈的振动，一旦减震控制不好，就会在飞行过程中产生很大的加速度，必会带来陀螺输出的变化，引入误差。这就是在陀螺仪数据手册上常见的deg/sec/g指标。
* 积分误差
对陀螺仪角速度的积分是离散的，长时间的积分会出现漂移的情况。所以要考虑积分误差的问题。
这是由于陀螺仪测量姿态存在这么多的误差，所以我们必须要使用其它传感器辅助校正，其中最重要的就是下面的加速度传感器。

### 加速度计
加速度计的低频特性好，可以测量低速的静态加速度。在我们的飞行器上，就是对重力加速度g（也就是前面说的静态加速度）的测量和分析，其它瞬间加速度可以忽略。记住这一点对姿态解算融合理解非常重要。
当我们把加速度计拿在手上随意转动时，我们看的是重力加速度在三个轴上的分量值。加速度计在自由落体时，其输出为0。为什么会这样呢？这里涉及到加速度计的设计原理：加速度计测量加速度是通过比力来测量，而不是通过加速度。
加速度计仅仅测量的是重力加速度，3轴加速度计输出重力加速度在加速度计所在机体坐标系3个轴上的分量大小。重力加速度的方向和大小是固定的。通过这种关系，可以得到加速度计所在平面与地面的角度关系.
加速度计若是绕着重力加速度的轴转动，则测量值不会改变，也就是说加速度计无法感知这种水平旋转。
有关陀螺仪和加速度计和关系，姿态解算融合的原理，再把下面这个比喻放到这里一遍。
> 机体好似一条船，姿态就是航向（船头的方位），重力是灯塔，陀螺（角速度积分）是舵手，加速度计是瞭望手。舵手负责估计和把稳航向，他相信自己，本来船向北开的，就一定会一直往北开，觉得转了90度弯，那就会往东开。当然如果舵手很牛逼，也许能估计很准确，维持很长时间。不过只信任舵手，肯定会迷路，所以一般都有瞭望手来观察误差。
瞭望手根据地图灯塔方位和船的当前航向，算出灯塔理论上应该在船的X方位。然而看到实际灯塔在船的Y方位，那肯定船的当前航向有偏差了，偏差就是ERR=X-Y。舵手收到瞭望手给的ERR报告，觉得可靠，那就听个90%ERR，觉得天气不好、地图误差大，那就听个10%ERR，根据这个来纠正估算航向。

### 磁力计
#### 基础知识
磁力计（Magnetic、M-Sensor）也叫地磁、磁感器，可用于测试磁场强度和方向，定位设备的方位，磁力计的原理跟指南针原理类似，可以测量出当前设备与东南西北四个方向上的夹角。所以，陀螺仪知道“我们转了个身”，加速计知道“我们又向前走了几米”，而磁力计则知道“我们是向西方向”的。
地球的磁场象一个条形磁体一样由磁南极指向磁北极。在磁极点处磁场和当地的水平面垂直，在赤道磁场和当地的水平面平行，所以在北半球磁场方向倾斜指向地面。用来衡量磁感应强度大小的单位是Tesla或者Gauss（1Tesla=10000Gauss）。随着地理位置的不同，通常地磁场的强度是0.4-0.6 Gauss。需要注意的是，磁北极和地理上的北极并不重合，通常他们之间有11度左右的夹角。
地磁场是一个矢量，对于一个固定的地点来说，这个矢量可以被分解为两个与当地水平面平行的分量和一个与当地水平面垂直的分量。如果保持电子罗盘和当地的水平面平行，那么罗盘中磁力计的三个轴就和这三个分量对应起来
>![磁力计分量][14]

实际上对水平方向的两个分量来说，他们的矢量和总是指向磁北的。罗盘中的航向角（Azimuth）就是当前方向和磁北的夹角。由于罗盘保持水平，只需要用磁力计水平方向两轴（通常为X轴和Y轴）的检测数据就可以计算出航向角。当罗盘水平旋转的时候，航向角在0- 360之间变化

#### 磁场干扰
电子指南针主要是通过感知地球磁场的存在来计算磁北极的方向。然而由于地球磁场在一般情况下只有微弱的0.5高斯，而一个普通的手机喇叭当相距2厘米时仍会有大约4高斯的磁场，一个手机马达在相距2厘米时会有大约6高斯的磁场，这一特点使得针对电子设备表面地球磁场的测量很容易受到电子设备本身的干扰

#### 校准方式
这里之谈笔者使用的校准方式
首先需要收集磁力计在各个轴上的最大最小值，之后找出反应最大的一轴数据
将其比例值设为1，其余的轴的比例值由反应最大轴的最大最小值之差除以该轴的最大最小值只差来求得。之后对其偏置补偿，就是找到一元一次函数中的那个常数值。如果设其中一个轴的比例系数为X~s~，那么偏置数X~b~的值为
X~b~=X~s~[1/2(X~max~-X~min~)-X~max~]
最后对原始值进行修正：
X~out~=X~in~*X~s~+X~b~



### MPU6050
MPU-60x0是全球首例6轴运动处理传感器。它集成了3轴MEMS陀螺仪，3轴MEMS加速度计，以及一个可扩展的数字运动处理器DMP（Digital Motion Processor），可用I2C接口连接一个第三方的数字传感器，比如磁力计。扩展之后就可以通过其I2C或SPI接口输出一个6轴的信号（SPI接口仅在MPU-6000可用）。MPU-60x0也可以通过其I2C接口连接非惯性的数字传感器，比如压力传感器。

MPU-60x0对陀螺仪和加速度计分别用了三个16位的ADC，将其测量的模拟量转化为可输出的数字量。为了精确跟踪快速和慢速的运动，传感器的测量范围都是用户可控的，陀螺仪可测范围为±250，±500，±1000，±2000°/秒（dps），加速度计可测范围为±2，±4，±8，±16g。一个片上1024字节的FIFO，有助于降低系统功耗。和所有设备寄存器之间的通信采用400kHz的I2C接口或1MHz 的SPI接口（SPI仅MPU-6000可用）。对于需要高速传输的应用，对寄存器的读取和中断可用20MHz的SPI。另外，片上还内嵌了一个温度传感器和在工作环境下仅有±1%变动的振荡器。
比如在开源飞控crazepony上，MPU6050/HMC5883/MS5611传感器之间的连接


### MPU9150
MPU-9150整合了MPU6050及AK8975电子罗盘功能(三轴陀螺仪 + 三轴加速度+三轴磁场)，IIC通信，芯片内置16bit AD转换器,16位数据输出（磁场13位）
陀螺仪范围：±250 500 1000 2000  °/s
加速度范围：±2±4±8±16g
磁场范围： ±1200uT

### MPU9250
MPU9150是只支持I2C的，MPU9250是支持SPI/I2C两种方式。里面的传感器也是不同的，MPU9150里面是MPU6050+AK8975，而MPU9250里面是MPU6500+AK8963，这两个传感器组合不同，前者性能上要高一些，后者主打低功耗方面的，各种参数要略低一些，比如唤醒速度等。


## 辅助理解

###  四元素与姿态阵间的关系
关系推导详细请看<<惯性导航>>292页 9.2.2章节。
用四元素来表示的变化矩阵公式为：
>![enter description here][15]

其中R是参考坐标系，对于方向余弦矩阵中的导航坐标系n，b系就是机体坐标系。
由于n系至b系的旋转过程中坐标系始终保持直角坐标系，所以矩阵为正交矩阵也就是C^b^~n~ = （C^n^~b~）^T^。
下面是绕三轴旋转的方向余弦矩阵
>![enter description here][16]

先统一变换方向为参考坐标系到机体坐标系
>![enter description here][17]

右方向余弦矩阵公式可得
>![enter description here][18]

将对应的余弦矩阵元素变为四元素矩阵的元素，就可以的到四元素与欧拉角的关系。也就是说，当参考坐标系到机体坐标系的四元素Q已经确定的时候，便可以计算出机体的航向角、俯仰角、横滚角。四元素包含了所以的姿态信息，捷联惯导中的姿态更新实质是如何计算四元素。

### 四元素的更新
<<惯性导航>>书中的四元素微分方程写的很详细，但这里就直接列出最后结果。利用龙格库塔更新四元数，只需要将传入上一次的四元数和新得到的角速度值再填上采样周期就可以更新四元数
最后的推倒公式为:
>![enter description here][19]
>下面附上部分推导供参考
>![enter description here][20]
>![enter description here][21]

### 四元数的初值确定
四元数的初值Q（0）由捷联惯导的初始对准确定。设初始对准确定的姿态阵为C^n^~b~[T~ij~]，根据四元数矩阵方程有如下方程成立：
>![enter description here][22]

由上述方程可解的
>![enter description here][23]

所以q0、q1、q2、q3的符号可按下式确定
>![enter description here][24]
上式中，sign（q0）的符号可任选

### 四元数的规范化
表征旋转的四元数应该是规范化四元数，即|| Q || = 1 ，但是由于计算误差等因素，计算过程中四元数会逐渐失去规范化特征，因此若干次更新后，必须对四元数做规范化处理:
>![enter description here][25]



## 相关数学知识
### 矩阵乘法
设A为  的矩阵，B为  的矩阵，那么称  的矩阵C为矩阵A与B的乘积，记作 
**C**=**AB** ，只有在矩阵A的列数和矩阵B的行数相同时才有意义
A矩阵从第一行开始，分别与矩阵B第一列的每个元素分别相乘求和，组成新矩阵的第一行第一列的元素，依次计算。
例如
>![enter description here][26]
有上述方程可解得


### 向量积（外积、叉积、叉乘）

![叉乘][27]
>![enter description here][28]

>![enter description here][29]

举例:
>向量：u=(u1,u2,u3) v=(v1,v2,v3)
叉积公式：u x v = { u2v3-v2u3 ,u3v1-v3u1 ,u1v2-u2v1 }
点积公式：u · v = u1v1+u2v2+u3v33=lul*lvl*COS(U,V)
*解算中用到叉乘主要是用来求误差*

### 四元素基本运算
定义两个四元数:
>![enter description here][30]
#### 加法：
![enter description here][31]
#### 乘法
列为乘数，行为被乘数
>![enter description here][32]
两个四元数之间的非可换乘积通常被称为格拉斯曼积
>![enter description here][33]
#### 模|p|
四元数的绝对值是四元数到原点的距离
>![enter description here][34]

#### 例子
![enter description here][35]


### 均值、标准差、方差
均值描述的是样本集合的中间点，它告诉我们的信息是有限的，而标准差给我们描述的是样本集合的各个样本点到均值的距离之平均
方差是衡量源数据和期望值相差的度量值。
>![enter description here][36]
>也可以写作
>![enter description here][37]

### 协方差
标准差和方差一般是用来描述一维数据的，但现实生活中我们常常会遇到含有多维数据的数据集，最简单的是大家上学时免不了要统计多个学科的考试成绩。面对这样的数据集，我们当然可以按照每一维独立的计算其方差，但是通常我们还想了解更多，比如，一个男孩子的猥琐程度跟他受女孩子的欢迎程度是否存在一些联系。协方差就是这样一种用来度量两个随机变量关系的统计量，我们可以仿照方差的定义：
![enter description here][38]
来度量各个维度偏离其均值的程度，协方差可以这样来定义：
![enter description here][39]
协方差的结果有什么意义呢？如果结果为正值，则说明两者是正相关的（从协方差可以引出“相关系数”的定义），也就是说一个人越猥琐越受女孩欢迎。如果结果为负值， 就说明两者是负相关，越猥琐女孩子越讨厌。如果为0，则两者之间没有关系，猥琐不猥琐和女孩子喜不喜欢之间没有关联，就是统计上说的“相互独立”。

### 协方差矩阵
前面提到的猥琐和受欢迎的问题是典型的二维问题，而协方差也只能处理二维问题，那维数多了自然就需要计算多个协方差，给出协方差矩阵的定义：
![enter description here][40]
我们可以举一个三维的例子，假设数据集有三个维度，则协方差矩阵为：
![enter description here][41]
可见，协方差矩阵是一个对称的矩阵，而且对角线是各个维度的方差。


### 弧度
在数学和物理中，弧度是角的度量单位。它是由国际单位制导出的单位，单位缩写是rad。根据定义，一周的弧度数为2πr/r=2π，360°角=2π弧度，因此，1弧度约为57.3°，即57°17'44.806''，1°为π/180弧度，近似值为0.01745弧度，周角为2π弧度，平角（即180°角）为π弧度，直角为π/2弧度。

# 姿态解算（融合）参考算法

## Mahony互补滤波算法
发现很多组织都使用这个人写的姿态解算，于是我们就来分析一下解算的流程。
代码示例见[MahonyAHRS.h](.././Code/C++/MahonyAHRS.h)

### 1.初始化四元素
### 2.用磁力计求出当前姿态与参考向量的偏差
* 三轴磁力计值归一化
参考代码
>>![enter description here][42]

* 将载体坐标系变为地面坐标系
*公式来源于四元素变化矩阵*
>>![enter description here][43]
* 算出北向量作为一个参考向量
*合成了X和Y轴，得到一个指向北方的向量*
>![enter description here][44]
* 将参考向量变为机体坐标系
>![enter description here][45]
*由于要在同一个坐标系下作对比，所以要将求得的参考向量转化为机体坐标系下的情况*
* 在机体坐标系下参考向量和姿态向量作叉乘求得误差

*归一化之后使用叉乘求得的便是两个向量的偏差值，将这个偏差值先保存起来*
>![enter description here][46]

### 3.用加速度计求出这一次与上一次重力向量的偏差
* 三轴加速度值归一化

*这里和磁力计一样，归一化是为了只考虑向量的方向*

>![enter description here][47]

*上一次四元素在机体坐标系下换算出来的重力的单位向量
这里通过四元数矩阵的第三列求得上一次的重力向量也就是Z轴，要注意的是是机体坐标系下，所以矩阵要按照需求进行转置，当你发现有的时候是取得第三行，而有的时候是第三列的时候，就是这个原因了。*

>![enter description here][48]
* 当前的重力的单位向量与上一次的做叉乘
*求出这一次和上一次的偏差值，并且累加偏差值*
>![enter description here][49]

* 将该误差累加到磁力计求得的误差中去
*这里将磁力计算出来的偏差和加速度计算出来的偏差相加合成了一个总的偏差用来修正陀螺仪，也就是说所的用磁力计和角速度计修正陀螺仪了*

### 4. 通过PI控制器使用上面两种偏差修正陀螺仪数据
到了这里需要的数据都已经凑齐，那么便使用PI控制器来对数据进行融合了。
>![enter description here][50]

>![enter description here][51]

通过这一步就能得到修正后的陀螺仪数据，也就是足以信赖的数据了
### 5. 使用龙格库塔公式更新四元数
使用上面得到的可靠角速度便能更新四元数了，这里使用龙格库塔公司来更新
>![enter description here][52]
得到的四元素便包含了机体的转动信息
### 6. 归一化四元数并更新相关数据
为啥要要归一化四元素上面有讲，方法上面也已经列出，这里就直接看代码吧
>![enter description here][53]
### 7. 通过四元数旋转矩阵得到姿态角
最后就是来求得我们期望的姿态角了，这里是通过方向余弦矩阵和四元素矩阵来求得的，详细可以看上面四元素和姿态阵间的关系
>![enter description here][54]

注意的是三角函数需要把它换算成弧度制哦。


整理：[lissettecarlr](https://github.com/lissettec)  &  [Neucrack](https://github.com/neutree)

  [1]: ./images/1470553636166.jpg "1470553636166.jpg"
  [2]: ./images/1470553944802.jpg "1470553944802.jpg"
  [3]: ./images/1468911037374.jpg "方向余弦阵列表示"
  [4]: ./images/1468923529526.jpg "推倒绕Z旋转矩阵作图"
  [5]: ./images/1468929681129.jpg "绕Z旋转的方向余弦矩阵等式"
  [6]: ./images/1468929954125.jpg "绕Z旋转的方向余弦矩阵"
  [7]: ./images/1468930290032.jpg "矩阵元素投影关系"
  [8]: ./images/1468933630888.jpg "旋转次序"
  [9]: ./images/1468933697625.jpg "基本旋转矩阵"
  [10]: ./images/1468933750616.jpg "依次绕Z X Y轴旋转"
  [11]: ./images/1468989013044.jpg "四元素的表示"
  [12]: ./images/1468991005367.jpg "1468991005367.jpg"
  [13]: ./images/1468991084621.jpg "1468991084621.jpg"
  [14]: ./images/1469342540013.jpg "磁力计分量.jpg"
  [15]: ./images/1468994043757.jpg "1468994043757.jpg"
  [16]: ./images/1468933750616.jpg "依次绕Z X Y轴旋转"
  [17]: ./images/1468994919345.jpg "1468994919345.jpg"
  [18]: ./images/1468994967054.jpg "1468994967054.jpg"
  [19]: ./images/1469021682922.jpg "龙格库塔更新四元数"
  [20]: ./images/1469021781936.jpg "1469021781936.jpg"
  [21]: ./images/1469021818030.jpg "1469021818030.jpg"
  [22]: ./images/1469022062269.jpg "1469022062269.jpg"
  [23]: ./images/1469022197666.jpg "1469022197666.jpg"
  [24]: ./images/1469022482706.jpg "1469022482706.jpg"
  [25]: ./images/1469022758001.jpg "1469022758001.jpg"
  [26]: ./images/1468912472920.jpg "矩阵乘法举例"
  [27]: ./images/1470565722961.jpg "叉乘"
  [28]: ./images/1468935494766.jpg "叉乘定义"
  [29]: ./images/1468935535944.jpg "叉乘几何意义"
  [30]: ./images/1468990296793.jpg "1468990296793.jpg"
  [31]: ./images/1468990324472.jpg "四元素加法"
  [32]: ./images/1468990470730.jpg "乘法表"
  [33]: ./images/1468990576521.jpg "乘法公式"
  [34]: ./images/1468990851879.jpg "四元素模的公式"
  [35]: ./images/1468990448801.jpg "加法和乘法举例"
  [36]: ./images/1468997622291.jpg "方差公式"
  [37]: ./images/1468998188056.jpg " "
  [38]: ./images/1468998398854.jpg " "
  [39]: ./images/1468998419036.jpg " "
  [40]: ./images/1468998658162.jpg " "
  [41]: ./images/1468998675484.jpg " "
  [42]: ./images/1469180078168.jpg " "
  [43]: ./images/1469180106450.jpg " "
  [44]: ./images/1469180283059.jpg " "
  [45]: ./images/1469180395128.jpg " "
  [46]: ./images/1469180502472.jpg " "
  [47]: ./images/1469180602270.jpg " "
  [48]: ./images/1469180743654.jpg " "
  [49]: ./images/1469180862341.jpg " "
  [50]: ./images/1469181315331.jpg "积分环节"
  [51]: ./images/1469181336206.jpg "比例环节"
  [52]: ./images/1469181800653.jpg " "
  [53]: ./images/1469181917052.jpg " "
  [54]: ./images/1469182223361.jpg " "